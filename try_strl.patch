From ef5baf3906b3a703519b3541225b1d0200b17276 Mon Sep 17 00:00:00 2001
From: holishing <holishing@ccns.ncku.edu.tw>
Date: Sun, 2 Nov 2025 02:40:03 +0800
Subject: [PATCH] fix(platform): avoid strlcpy/strlcat redefinition on glibc
 2.38+
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Newer glibc (â‰¥ 2.38) provides built-in implementations of strlcpy() and
strlcat(). Projects that also define these functions will now fail to
build due to symbol redefinition conflicts.

This patch is trying to verify whether strlcpy()/strlcat() are available
at compile time and only compiles the compatibility implementation
when missing. (e.g. glibc is older 2.38)

ref: https://sourceware.org/git/?p=glibc.git;a=commit;h=454a20c8756c9c1d55419153255fc7692b3d2199
---
 CMakeLists.txt | 13 +++++++++++++
 lib/string.c   |  4 ++++
 2 files changed, 17 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index b0af93164..fd4fca6eb 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -22,6 +22,19 @@ include(CheckCCompilerFlag)
 include(CheckSymbolExists)
 include(FindPkgConfig)
 
+#
+
+set(CMAKE_REQUIRED_INCLUDES "string.h")
+check_symbol_exists(strlcpy "string.h" HAVE_STRLCPY)
+check_symbol_exists(strlcat "string.h" HAVE_STRLCAT)
+
+if (HAVE_STRLCPY)
+  add_definitions(-DHAVE_STRLCPY=1)
+endif()
+if (HAVE_STRLCAT)
+  add_definitions(-DHAVE_STRLCAT=1)
+endif()
+
 ## Toolchain settings
 
 if(NOT USE_CXX)
diff --git a/lib/string.c b/lib/string.c
index b80f1e154..c6ac8daa9 100644
--- a/lib/string.c
+++ b/lib/string.c
@@ -1046,6 +1046,7 @@ GCC_NONNULLS
     }
 }
 
+#ifndef HAVE_STRLCAT
 /* strlcat based on OpenBSDs strlcat */
 
 /*
@@ -1070,7 +1071,9 @@ size_t strlcat(char *dst, const char *src, size_t siz)
 
     return dlen + slen + strlen(src + slen); /* count does not include NUL */
 }
+#endif
 
+#ifndef HAVE_STRLCPY
 /* strlcpy based on OpenBSDs strlcpy */
 /*
  * Copy src to string dst of size siz.  At most siz-1 characters
@@ -1096,3 +1099,4 @@ size_t strlcpy(char *dst, const char *src, size_t siz)
 
     return slen + strlen(src + slen); /* count does not include NUL */
 }
+#endif
